-- CPI fact data
CREATE VIEW VW_CPIDATA AS 
WITH CPI AS
(
SELECT 
     STG.country, 
     STG.ISO3CountryCode, 
     STG.Region, 
     STG.CPIScore, 
     STG.Rank, 
     STG.Sources, 
     STG.StandardError, 
     STG.Year, 
     RANK() over (partition by year order by CPIScore desc ) as missing_ranks
     FROM STG_CPIDATA STG
JOIN REF_REPORTING_COUNTRY 
  ON ISO3CountryCode = CountryCode
)
SELECT Country, 
       ISO3CountryCode, 
       Region, 
       ISNULL(cast(CPIScore as numeric(10)),0) AS CPIScore, 
       cast(CASE WHEN Rank is null then missing_ranks else Rank end as numeric(10)) as Rank,
       Year
FROM CPI;

-- wdi fact data
CREATE VIEW VW_WDIDATA
AS (
SELECT CountryName, CountryCode, IndicatorCode, REPLACE(IndicatorCode,'.','_') AS KPICODE,
       CAST(SUBSTRING(TRIM(YEAR),3,4) AS NUMERIC(10)) AS YEAR, 
       CASE WHEN ISNUMERIC(REPLACE(TRIM(KPIVALUE),',','')) = 0 
            THEN 0 
            ELSE ROUND(CAST(CAST(REPLACE(TRIM(KPIVALUE),',','') AS NUMERIC(38,20)) AS NUMERIC(20,4)),4)
            END AS KPIVALUE
       --KPIVALUE
FROM
(
SELECT 
      STG.CountryName, STG.CountryCode, IndicatorCode, 
      YR1960, YR1961, YR1962, YR1963, YR1964, YR1965, YR1966, YR1967, YR1968, YR1969,
      YR1970, YR1971, YR1972, YR1973, YR1974, YR1975, YR1976, YR1977, YR1978, YR1979,
      YR1980, YR1981, YR1982, YR1983, YR1984, YR1985, YR1986, YR1987, YR1988, YR1989,
      YR1990, YR1991, YR1992, YR1993, YR1994, YR1995, YR1996, YR1997, YR1998, YR1999,
      YR2000, YR2001, YR2002, YR2003, YR2004, YR2005, YR2006, YR2007, YR2008, YR2009,
      YR2010, YR2011, YR2012, YR2013, YR2014, YR2015, YR2016, YR2017, YR2018, YR2019,
      YR2020
  FROM STG_WDIDATA STG
  JOIN REF_REPORTING_COUNTRY C
    ON STG.CountryCode = C.CountryCode
  WHERE EXISTS (SELECT DISTINCT KPICODE FROM REF_KPILIST K WHERE STG.IndicatorCode = K.KPICODE)
) STG
UNPIVOT
     (KPIVALUE FOR YEAR IN (
      YR1960, YR1961, YR1962, YR1963, YR1964, YR1965, YR1966, YR1967, YR1968, YR1969,
      YR1970, YR1971, YR1972, YR1973, YR1974, YR1975, YR1976, YR1977, YR1978, YR1979,
      YR1980, YR1981, YR1982, YR1983, YR1984, YR1985, YR1986, YR1987, YR1988, YR1989,
      YR1990, YR1991, YR1992, YR1993, YR1994, YR1995, YR1996, YR1997, YR1998, YR1999,
      YR2000, YR2001, YR2002, YR2003, YR2004, YR2005, YR2006, YR2007, YR2008, YR2009,
      YR2010, YR2011, YR2012, YR2013, YR2014, YR2015, YR2016, YR2017, YR2018, YR2019,
      YR2020)
      )
 WDI
)
;